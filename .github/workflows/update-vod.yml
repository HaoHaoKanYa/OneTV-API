name: ğŸ¬ Update VOD Sources

on:
  schedule:
    # æ¯å‘¨æ—¥24ç‚¹æ‰§è¡Œ (åŒ—äº¬æ—¶é—´å‘¨ä¸€8ç‚¹)
    - cron: '0 16 * * 0'
  workflow_dispatch:
    inputs:
      force_update:
        description: 'å¼ºåˆ¶æ›´æ–°æ‰€æœ‰ç‚¹æ’­æº'
        required: false
        default: 'false'
        type: boolean

env:
  TZ: Asia/Shanghai

jobs:
  update-vod-sources:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸš€ Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: ğŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then
          pip install -r requirements.txt
        else
          pip install aiohttp tqdm requests configparser bs4 async-timeout flask opencc-python-reimplemented pillow m3u8 pytz
        fi
    
    - name: ğŸ“ Create VOD directories
      run: |
        mkdir -p vod/config
        mkdir -p vod/output
        mkdir -p vod/cache
        mkdir -p vod/logs
    
    - name: ğŸ¬ Update VOD sources
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        FORCE_UPDATE: ${{ github.event.inputs.force_update }}
      run: |
        echo "ğŸ¬ å¼€å§‹OneTV-APIç‚¹æ’­æºæ›´æ–°..."
        echo "â° æ‰§è¡Œæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
        echo "ğŸ”§ å¼ºåˆ¶æ›´æ–°: ${FORCE_UPDATE:-false}"
        echo "ğŸ“ å½“å‰ç›®å½•: $(pwd)"
        echo "ğŸ“‚ ç›®å½•å†…å®¹:"
        ls -la
        echo "ğŸ” æ£€æŸ¥VODæ¨¡å—:"
        ls -la updates/vod/ || echo "VODç›®å½•ä¸å­˜åœ¨"
        echo "ğŸ Pythonç‰ˆæœ¬: $(python --version)"
        echo "ğŸ“¦ å·²å®‰è£…åŒ…:"
        pip list | grep -E "(aiohttp|tqdm|requests)"

        python -c "
        import asyncio
        import sys
        import os
        import traceback
        sys.path.append('.')

        print('ğŸ” Pythonè·¯å¾„:', sys.path)
        print('ğŸ“ å½“å‰å·¥ä½œç›®å½•:', os.getcwd())

        try:
            print('ğŸ“¥ å°è¯•å¯¼å…¥VODæ¨¡å—...')
            from updates.vod.request import update_vod_sources
            print('âœ… VODæ¨¡å—å¯¼å…¥æˆåŠŸ!')
        except Exception as e:
            print(f'âŒ VODæ¨¡å—å¯¼å…¥å¤±è´¥: {str(e)}')
            print('ğŸ“‹ è¯¦ç»†é”™è¯¯ä¿¡æ¯:')
            traceback.print_exc()
            exit(1)

        async def main():
            try:
                print('ğŸš€ å¼€å§‹æ‰§è¡ŒVODæ›´æ–°...')
                success = await update_vod_sources()
                if success:
                    print('âœ… ç‚¹æ’­æºæ›´æ–°æˆåŠŸ!')
                    exit(0)
                else:
                    print('âŒ ç‚¹æ’­æºæ›´æ–°å¤±è´¥!')
                    exit(1)
            except Exception as e:
                print(f'âŒ ç‚¹æ’­æºæ›´æ–°å¼‚å¸¸: {str(e)}')
                print('ğŸ“‹ è¯¦ç»†é”™è¯¯ä¿¡æ¯:')
                traceback.print_exc()
                exit(1)

        if __name__ == '__main__':
            asyncio.run(main())
        "
    
    - name: ğŸ“Š Generate update summary
      if: always()
      run: |
        echo "## ğŸ¬ OneTV-API ç‚¹æ’­æºæ›´æ–°æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“… æ›´æ–°ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
        echo "- **æ›´æ–°æ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
        echo "- **è§¦å‘æ–¹å¼**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **å·¥ä½œæµ**: ç‚¹æ’­æºä¸“ç”¨æ›´æ–°æµç¨‹" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        python3 scripts/generate_vod_summary.py >> $GITHUB_STEP_SUMMARY
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ”— è®¿é—®åœ°å€" >> $GITHUB_STEP_SUMMARY
        if [ -n "${{ secrets.SUPABASE_URL }}" ]; then
          echo "- **VODé…ç½®æ–‡ä»¶**: ${{ secrets.SUPABASE_URL }}/storage/v1/object/public/vod-sources/onetv-api-movie.json" >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸ Supabaseé…ç½®æœªè®¾ç½®ï¼Œæ— æ³•ç”Ÿæˆè®¿é—®åœ°å€" >> $GITHUB_STEP_SUMMARY
        fi
    
    - name: ğŸ“ Upload logs as artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: vod-update-logs-${{ github.run_number }}
        path: |
          vod/output/
          vod/logs/
        retention-days: 30
    
    - name: ğŸ”” Notify on failure
      if: failure()
      run: |
        echo "âŒ ç‚¹æ’­æºæ›´æ–°å¤±è´¥!"
        echo "è¯·æ£€æŸ¥ä»¥ä¸‹å¯èƒ½çš„é—®é¢˜:"
        echo "1. ç½‘ç»œè¿æ¥é—®é¢˜"
        echo "2. ç‚¹æ’­æºé…ç½®æ–‡ä»¶æ ¼å¼é”™è¯¯"
        echo "3. Supabaseé…ç½®é—®é¢˜"
        echo "4. Pythonä¾èµ–é—®é¢˜"
        
        # å¦‚æœæœ‰æ—¥å¿—æ–‡ä»¶ï¼Œæ˜¾ç¤ºæœ€åå‡ è¡Œ
        if [ -f "vod/logs/error.log" ]; then
          echo ""
          echo "æœ€è¿‘çš„é”™è¯¯æ—¥å¿—:"
          tail -20 vod/logs/error.log
        fi
