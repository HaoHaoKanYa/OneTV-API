# 📖 OneTV-API 详细使用教程

## 🚀 快速开始

### 环境要求
- Python 3.13+
- Git
- 网络连接

### 1. 获取项目
```bash
# 克隆项目
git clone https://github.com/HaoHaoKanYa/OneTV-API.git
cd OneTV-API

# 或者下载ZIP包解压
```

### 2. 安装依赖
```bash
# 使用pipenv（推荐）
pip install pipenv
pipenv install --dev

# 或使用pip
pip install -r requirements.txt
```

### 3. 基础运行
```bash
# 启动更新程序
pipenv run dev

# 启动Web服务
pipenv run service

# 启动GUI界面
pipenv run ui
```

## ⚙️ 配置详解

### 主配置文件 (config/config.ini)

#### 基础开关配置
```ini
# 开启更新功能
open_update = True

# 开启Web服务
open_service = True

# 开启测速功能
open_speed_test = True

# 开启EPG功能
open_epg = True

# 开启M3U格式输出
open_m3u_result = True
```

#### 数据源配置
```ini
# 本地源
open_local = True
local_file = config/local.txt
local_num = 10

# 订阅源
open_subscribe = True
subscribe_num = 10

# 酒店源
open_hotel = False
open_hotel_foodie = True
open_hotel_fofa = False
hotel_num = 10

# 组播源
open_multicast = False
open_multicast_foodie = True
open_multicast_fofa = False
multicast_num = 10

# 在线搜索
open_online_search = False
online_search_num = 0
```

#### 测速和过滤配置
```ini
# 测速参数
speed_test_limit = 10          # 并发测速数量
speed_test_timeout = 10        # 单个接口超时时间
speed_test_filter_host = False # 是否按Host过滤

# 质量过滤
open_filter_speed = True       # 开启速率过滤
min_speed = 0.5               # 最小速率(M/s)

open_filter_resolution = True  # 开启分辨率过滤
min_resolution = 1920x1080    # 最小分辨率
max_resolution = 1920x1080    # 最大分辨率
```

#### 网络和协议配置
```ini
# 协议类型
ipv_type = 全部               # 可选: ipv4, ipv6, 全部
ipv_type_prefer = auto        # 协议偏好
ipv6_support = False          # 强制IPv6支持

# 接口数量
ipv4_num = 5                  # IPv4接口数量
ipv6_num = 5                  # IPv6接口数量
urls_limit = 10               # 单频道接口数量
```

#### 地区和运营商过滤
```ini
# 地区过滤（支持关键字，逗号分隔）
location = 

# 运营商过滤（支持关键字，逗号分隔）
isp = 

# 数据源优先级（逗号分隔）
origin_type_prefer = local,hotel,multicast,subscribe,online_search
```

#### 定时和服务配置
```ini
# 定时更新间隔（小时，0表示只运行一次）
update_interval = 12

# 时区设置
time_zone = Asia/Shanghai

# Web服务配置
app_host = http://localhost
app_port = 8000

# RTMP推流
open_rtmp = False
```

### 频道模板配置 (config/demo.txt)

#### 基本格式
```
分类名称,#genre#
频道名称1
频道名称2
频道名称3

另一个分类,#genre#
频道名称4
频道名称5
```

#### 示例配置
```
📺央视频道,#genre#
CCTV-1
CCTV-2
CCTV-3
CCTV-4
CCTV-5

📡卫视频道,#genre#
湖南卫视
浙江卫视
江苏卫视
东方卫视

🏀体育频道,#genre#
CCTV-5
CCTV-5+
广东体育
五星体育
```

### 本地源配置 (config/local.txt)

#### 格式说明
```
频道名称,直播源URL
频道名称,直播源URL1
频道名称,直播源URL2
```

#### 示例配置
```
CCTV-1,http://example.com/cctv1.m3u8
CCTV-2,http://example.com/cctv2.m3u8
湖南卫视,http://example.com/hunan.m3u8
浙江卫视,http://example.com/zhejiang.m3u8
```

### 订阅源配置 (config/subscribe.txt)

#### 格式说明
每行一个订阅源URL：
```
http://example.com/playlist1.m3u8
http://example.com/playlist2.txt
https://raw.githubusercontent.com/user/repo/main/list.m3u8
```

### 白名单和黑名单

#### 白名单 (config/whitelist.txt)
只保留包含这些关键字的源：
```
cctv
卫视
体育
```

#### 黑名单 (config/blacklist.txt)
过滤包含这些关键字的源：
```
测试
test
demo
```

## 🐳 Docker 部署教程

### 基础部署
```bash
# 拉取镜像
docker pull haohaokanya/onetv-api:latest

# 运行容器
docker run -d \
  --name onetv-api \
  -p 8000:8000 \
  haohaokanya/onetv-api
```

### 挂载配置部署（推荐）
```bash
# 创建本地配置目录
mkdir -p ./config ./output

# 复制默认配置
cp -r /path/to/OneTV-API/config/* ./config/

# 运行容器并挂载
docker run -d \
  --name onetv-api \
  -p 8000:8000 \
  -v $(pwd)/config:/onetv-api/config \
  -v $(pwd)/output:/onetv-api/output \
  haohaokanya/onetv-api
```

### Docker Compose 部署
创建 `docker-compose.yml`：
```yaml
version: '3.8'
services:
  onetv-api:
    image: haohaokanya/onetv-api:latest
    container_name: onetv-api
    ports:
      - "8000:8000"
    volumes:
      - ./config:/onetv-api/config
      - ./output:/onetv-api/output
    environment:
      - APP_HOST=http://localhost
      - APP_PORT=8000
    restart: unless-stopped
```

运行：
```bash
docker-compose up -d
```

## 🔧 高级配置

### RTMP推流配置
```ini
# 开启RTMP功能
open_rtmp = True

# 配置推流地址
app_host = http://your-domain.com
```

创建推流目录：
```bash
mkdir -p config/live config/hls
```

将视频文件放入对应目录，文件名为频道名称。

### EPG配置
```ini
# 开启EPG
open_epg = True

# EPG文件会自动生成到 output/epg/ 目录
```

### 性能优化配置
```ini
# 提高并发数（注意服务器性能）
speed_test_limit = 20

# 减少超时时间（提高速度但可能丢失慢速源）
speed_test_timeout = 5

# 开启Host过滤（大幅减少测速时间）
speed_test_filter_host = True

# 减少获取天数（避免匹配问题）
recent_days = 15
```

## 📱 GUI 使用教程

### 启动GUI
```bash
pipenv run ui
```

### 界面功能
1. **配置选项卡** - 修改各种配置参数
2. **频道模板** - 编辑频道模板
3. **本地源** - 管理本地直播源
4. **订阅源** - 管理订阅源列表
5. **测速设置** - 调整测速参数
6. **启动按钮** - 开始更新过程

### 使用步骤
1. 根据需要调整配置
2. 编辑频道模板
3. 添加本地源或订阅源
4. 点击"启动"开始更新
5. 查看进度和结果

## 🌐 API 接口使用

### 获取播放列表
```bash
# 默认格式
curl http://localhost:8000/

# M3U格式
curl http://localhost:8000/m3u

# TXT格式
curl http://localhost:8000/txt

# IPv4专用
curl http://localhost:8000/ipv4/m3u

# IPv6专用
curl http://localhost:8000/ipv6/m3u
```

### RTMP推流接口
```bash
# Live推流列表
curl http://localhost:8000/live/m3u

# HLS推流列表
curl http://localhost:8000/hls/m3u
```

### 管理接口
```bash
# 查看日志
curl http://localhost:8000/log

# 查看内容
curl http://localhost:8000/content
```

## 🔍 故障排除

### 常见问题

#### 1. 更新无数据
**解决方案：**
```ini
# 开启浏览器模式
open_driver = True

# 开启查询请求
open_request = True

# 检查网络连接
```

#### 2. 测速过慢
**解决方案：**
```ini
# 减少并发数
speed_test_limit = 5

# 开启Host过滤
speed_test_filter_host = True

# 减少超时时间
speed_test_timeout = 5
```

#### 3. 结果为空
**解决方案：**
```ini
# 开启补偿机制
open_supply = True

# 降低最小速率
min_speed = 0.1

# 检查频道模板格式
```

#### 4. IPv6不工作
**解决方案：**
```ini
# 强制开启IPv6支持
ipv6_support = True

# 检查网络IPv6连通性
```

### 日志查看
```bash
# 查看输出日志
cat output/log/latest.log

# 实时查看日志
tail -f output/log/latest.log
```

### 调试模式
```bash
# 开启详细日志
export DEBUG=1
pipenv run dev
```

## 📊 性能监控

### 查看统计信息
访问 `http://localhost:8000/log` 查看：
- 测速统计
- 成功率
- 平均响应时间
- 源质量分布

### RTMP推流监控
访问 `http://localhost:8080/stat` 查看：
- 推流状态
- 连接数
- 带宽使用
- 在线时长

---

> **提示**: 更多高级配置和使用技巧，请参考项目的 `docs/` 目录或访问官方文档。
