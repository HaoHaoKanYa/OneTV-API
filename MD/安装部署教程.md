# 🚀 OneTV-API 安装部署教程

## 📋 系统要求

### 最低要求
- **操作系统**: Windows 10+, Ubuntu 18.04+, macOS 10.15+
- **Python**: 3.13+
- **内存**: 512MB+
- **存储**: 1GB+
- **网络**: 稳定的互联网连接

### 推荐配置
- **操作系统**: Ubuntu 20.04+ / Windows 11
- **Python**: 3.13
- **内存**: 2GB+
- **存储**: 5GB+
- **网络**: 100Mbps+

## 🔧 环境准备

### Windows 环境

#### 1. 安装Python
```bash
# 下载Python 3.13
# 访问 https://www.python.org/downloads/
# 安装时勾选 "Add Python to PATH"

# 验证安装
python --version
pip --version
```

#### 2. 安装Git
```bash
# 下载Git
# 访问 https://git-scm.com/download/win
# 按默认选项安装

# 验证安装
git --version
```

#### 3. 安装FFmpeg（可选，用于分辨率过滤）
```bash
# 下载FFmpeg
# 访问 https://ffmpeg.org/download.html
# 解压到 C:\ffmpeg
# 添加 C:\ffmpeg\bin 到系统PATH
```

### Linux 环境

#### Ubuntu/Debian
```bash
# 更新包列表
sudo apt update

# 安装Python 3.13
sudo apt install python3.13 python3.13-pip python3.13-venv

# 安装Git
sudo apt install git

# 安装FFmpeg（可选）
sudo apt install ffmpeg

# 验证安装
python3.13 --version
git --version
ffmpeg -version
```

#### CentOS/RHEL
```bash
# 安装EPEL仓库
sudo yum install epel-release

# 安装Python 3.13
sudo yum install python3.13 python3.13-pip

# 安装Git
sudo yum install git

# 安装FFmpeg（可选）
sudo yum install ffmpeg

# 验证安装
python3.13 --version
git --version
```

### macOS 环境

#### 使用Homebrew
```bash
# 安装Homebrew
/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

# 安装Python 3.13
brew install python@3.13

# 安装Git
brew install git

# 安装FFmpeg（可选）
brew install ffmpeg

# 验证安装
python3.13 --version
git --version
ffmpeg -version
```

## 📦 项目安装

### 方式一：Git克隆（推荐）
```bash
# 克隆项目
git clone https://github.com/HaoHaoKanYa/OneTV-API.git

# 进入项目目录
cd OneTV-API

# 查看项目结构
ls -la
```

### 方式二：下载ZIP包
```bash
# 访问 https://github.com/HaoHaoKanYa/OneTV-API
# 点击 "Code" -> "Download ZIP"
# 解压到目标目录

# 进入解压目录
cd OneTV-API-main
```

## 🐍 Python环境配置

### 方式一：使用Pipenv（推荐）
```bash
# 安装pipenv
pip install pipenv

# 安装项目依赖
pipenv install --dev

# 激活虚拟环境
pipenv shell

# 验证安装
pipenv run python --version
```

### 方式二：使用venv
```bash
# 创建虚拟环境
python -m venv venv

# 激活虚拟环境
# Windows:
venv\Scripts\activate
# Linux/macOS:
source venv/bin/activate

# 安装依赖
pip install -r requirements.txt

# 验证安装
python --version
```

### 方式三：直接安装
```bash
# 直接安装依赖（不推荐）
pip install -r requirements.txt
```

## ⚙️ 基础配置

### 1. 复制配置文件
```bash
# 配置文件已包含在项目中，可直接使用
# 或根据需要修改 config/config.ini
```

### 2. 编辑主配置
```bash
# 编辑配置文件
nano config/config.ini
# 或使用其他编辑器
```

关键配置项：
```ini
# 基础功能开关
open_update = True
open_service = True
open_speed_test = True

# 数据源配置
open_local = True
open_subscribe = True

# 测速配置
speed_test_limit = 10
speed_test_timeout = 10
min_speed = 0.5

# 服务配置
app_port = 8000
```

### 3. 配置频道模板
```bash
# 编辑频道模板
nano config/demo.txt
```

添加您需要的频道：
```
📺央视频道,#genre#
CCTV-1
CCTV-2
CCTV-3

📡卫视频道,#genre#
湖南卫视
浙江卫视
江苏卫视
```

## 🚀 运行测试

### 1. 基础运行测试
```bash
# 使用pipenv
pipenv run dev

# 或直接运行
python main.py
```

### 2. Web服务测试
```bash
# 启动Web服务
pipenv run service

# 或直接运行
python service/app.py
```

### 3. 访问测试
```bash
# 测试Web接口
curl http://localhost:8000/

# 或在浏览器访问
# http://localhost:8000/
```

## 🐳 Docker 部署

### 1. 安装Docker

#### Windows
```bash
# 下载Docker Desktop
# 访问 https://www.docker.com/products/docker-desktop
# 安装并启动Docker Desktop
```

#### Linux
```bash
# Ubuntu/Debian
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh
sudo usermod -aG docker $USER

# 启动Docker服务
sudo systemctl start docker
sudo systemctl enable docker
```

#### macOS
```bash
# 下载Docker Desktop for Mac
# 访问 https://www.docker.com/products/docker-desktop
# 安装并启动
```

### 2. 拉取镜像
```bash
# 拉取最新镜像
docker pull haohaokanya/onetv-api:latest

# 或使用代理（国内用户）
docker pull docker.1ms.run/haohaokanya/onetv-api:latest
```

### 3. 运行容器
```bash
# 基础运行
docker run -d \
  --name onetv-api \
  -p 8000:8000 \
  haohaokanya/onetv-api:latest

# 挂载配置运行（推荐）
docker run -d \
  --name onetv-api \
  -p 8000:8000 \
  -v $(pwd)/config:/onetv-api/config \
  -v $(pwd)/output:/onetv-api/output \
  haohaokanya/onetv-api:latest
```

### 4. Docker Compose 部署
创建 `docker-compose.yml`：
```yaml
version: '3.8'

services:
  onetv-api:
    image: haohaokanya/onetv-api:latest
    container_name: onetv-api
    restart: unless-stopped
    ports:
      - "8000:8000"
    volumes:
      - ./config:/onetv-api/config
      - ./output:/onetv-api/output
    environment:
      - APP_HOST=http://localhost
      - APP_PORT=8000
      - TZ=Asia/Shanghai
```

运行：
```bash
# 启动服务
docker-compose up -d

# 查看日志
docker-compose logs -f

# 停止服务
docker-compose down
```

## 🌐 生产环境部署

### 1. 使用Nginx反向代理
```nginx
# /etc/nginx/sites-available/iptv-api
server {
    listen 80;
    server_name your-domain.com;

    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

启用配置：
```bash
sudo ln -s /etc/nginx/sites-available/onetv-api /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

### 2. 使用Gunicorn运行
```bash
# 安装gunicorn（已包含在依赖中）
pipenv install gunicorn

# 运行gunicorn
pipenv run gunicorn -w 4 -b 0.0.0.0:8000 service.app:app
```

### 3. 创建系统服务
创建 `/etc/systemd/system/onetv-api.service`：
```ini
[Unit]
Description=OneTV-API Service
After=network.target

[Service]
Type=simple
User=www-data
WorkingDirectory=/path/to/iptv-api
Environment=PATH=/path/to/iptv-api/.venv/bin
ExecStart=/path/to/iptv-api/.venv/bin/gunicorn -w 4 -b 127.0.0.1:8000 service.app:app
Restart=always

[Install]
WantedBy=multi-user.target
```

启用服务：
```bash
sudo systemctl daemon-reload
sudo systemctl enable onetv-api
sudo systemctl start onetv-api
sudo systemctl status onetv-api
```

## 📊 监控和维护

### 1. 日志监控
```bash
# 查看应用日志
tail -f output/log/latest.log

# 查看系统服务日志
sudo journalctl -u onetv-api -f

# 查看Docker日志
docker logs -f onetv-api
```

### 2. 性能监控
```bash
# 查看资源使用
htop
# 或
top

# 查看Docker容器资源
docker stats onetv-api
```

### 3. 定期维护
```bash
# 清理旧日志
find output/log -name "*.log" -mtime +7 -delete

# 更新项目
git pull origin main
pipenv install --dev

# 重启服务
sudo systemctl restart onetv-api
```

## 🔧 故障排除

### 常见问题

#### 1. 端口被占用
```bash
# 查看端口占用
netstat -tulpn | grep 8000
# 或
lsof -i :8000

# 修改端口
# 编辑 config/config.ini 中的 app_port
```

#### 2. 权限问题
```bash
# 修改文件权限
chmod +x main.py
chmod -R 755 output/

# 修改所有者
chown -R $USER:$USER ./
```

#### 3. 依赖安装失败
```bash
# 更新pip
pip install --upgrade pip

# 清理缓存
pip cache purge

# 重新安装
pipenv install --dev --clear
```

#### 4. 内存不足
```bash
# 减少并发数
# 编辑 config/config.ini
speed_test_limit = 5

# 或增加系统内存/交换空间
```

### 调试模式
```bash
# 开启调试模式
export DEBUG=1
pipenv run dev

# 查看详细错误信息
python -u main.py 2>&1 | tee debug.log
```

## 🔄 自动化部署脚本

### 一键安装脚本
创建 `install.sh`：
```bash
#!/bin/bash

# OneTV-API 一键安装脚本

echo "开始安装 OneTV-API..."

# 检查Python版本
python3 --version || { echo "请先安装Python 3.13+"; exit 1; }

# 安装pipenv
pip3 install pipenv

# 克隆项目
git clone https://github.com/HaoHaoKanYa/OneTV-API.git
cd OneTV-API

# 安装依赖
pipenv install --dev

# 创建输出目录
mkdir -p output/{log,data,epg,ipv4,ipv6}

# 设置权限
chmod +x main.py service/app.py

echo "安装完成！"
echo "运行命令："
echo "  更新: pipenv run dev"
echo "  服务: pipenv run service"
echo "  界面: pipenv run ui"
```

使用脚本：
```bash
chmod +x install.sh
./install.sh
```

---

> **注意**: 生产环境部署时，请确保配置防火墙规则，定期备份配置文件，并监控系统资源使用情况。
